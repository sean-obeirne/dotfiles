#!/usr/bin/env python3

# author:	Sean O'Beirne
# file:		open-project

# usage: open-project 

# 

################################################################################

import curses
import os
import subprocess
import shutil
from pathlib import Path
from typing import Optional, Tuple

# ---------- Config ----------
DEFAULT_ROOT = Path("/home/sean/code")
# Allow override via env var:
ROOT = Path(os.environ.get("PROJECTS_DIR", str(DEFAULT_ROOT)))

# Preferred editors/terminals (auto-detected where sensible)
VSCODE_CMD = shutil.which("code") or shutil.which("code-oss")
NVIM_CMD = shutil.which("nvim") or "nvim"
ALACRITTY_CMD = shutil.which("alacritty") or "alacritty"
SHELL = os.environ.get("SHELL", "bash")
# ----------------------------

# global attr for "terminal default colors" (transparent bg)
TRANSP = None  # type: ignore[assignment]

def list_project_dirs(root: Path) -> list[str]:
    if not root.exists():
        return []
    dirs = []
    for entry in sorted(root.iterdir(), key=lambda p: p.name.lower()):
        try:
            if entry.is_dir():
                dirs.append(entry.name)
        except PermissionError:
            pass
    return dirs

class ListView:
    def __init__(self, items: list[str]):
        self.items_all = items[:]  # unfiltered
        self.query = ""
        self.filtered = items[:]
        self.index = 0
        self.top = 0

    def set_items(self, items: list[str]):
        self.items_all = items[:]
        self.apply_filter()

    def apply_filter(self):
        if not self.query:
            self.filtered = self.items_all[:]
        else:
            q = self.query.lower()
            self.filtered = [x for x in self.items_all if q in x.lower()]
        self.index = max(0, min(self.index, max(0, len(self.filtered)-1)))
        self.top = min(self.top, max(0, len(self.filtered)-1))

    def handle_key(self, key, height):
        # navigation
        if key in (curses.KEY_DOWN, ord('j')):
            if self.index < len(self.filtered)-1:
                self.index += 1
                if self.index >= self.top + height:
                    self.top += 1
        elif key in (curses.KEY_UP, ord('k')):
            if self.index > 0:
                self.index -= 1
                if self.index < self.top:
                    self.top -= 1
        elif key in (curses.KEY_NPAGE, ):  # Page Down
            self.index = min(self.index + height, len(self.filtered)-1)
            self.top = min(self.top + height, max(0, len(self.filtered)-height))
        elif key in (curses.KEY_PPAGE, ):  # Page Up
            self.index = max(self.index - height, 0)
            self.top = max(self.top - height, 0)
        # filtering
        elif key == 27:  # ESC clears query
            self.query = ""
            self.apply_filter()
        elif key in (curses.KEY_BACKSPACE, 127, 8):
            if self.query:
                self.query = self.query[:-1]
                self.apply_filter()
        elif key == ord('/'):
            self.query = ""
            self.apply_filter()
        elif 32 <= key <= 126:  # printable ASCII
            self.query += chr(key)
            self.apply_filter()

    def current(self) -> Optional[str]:
        if not self.filtered:
            return None
        return self.filtered[self.index]

def draw_border(win):
    h, w = win.getmaxyx()
    win.attron((TRANSP or curses.A_NORMAL) | curses.A_DIM)
    win.border()
    win.attroff((TRANSP or curses.A_NORMAL) | curses.A_DIM)

def prompt_action(stdscr, project_path: Path) -> Optional[str]:
    """
    Modal to choose action: vscode, nvim, alacritty, cancel
    Returns one of: 'vscode','nvim','alacritty', or None
    """
    actions = [
        ("Open in VS Code", "vscode", "v"),
        ("Open in Neovim (in Alacritty)", "nvim", "n"),
        ("Open in Alacritty", "alacritty", "a"),
        ("Cancel", None, "c")
    ]
    h, w = stdscr.getmaxyx()
    width = max(50, min(80, w - 6))
    height = len(actions) + 6
    x = (w - width) // 2
    y = (h - height) // 2
    win = curses.newwin(height, width, y, x)
    draw_border(win)
    title = f"Choose action for: {project_path.name}"
    win.addstr(1, 2, title[:width-4], (TRANSP or curses.A_NORMAL) | curses.A_BOLD)
    win.addstr(2, 2, str(project_path)[:width-4], (TRANSP or curses.A_NORMAL) | curses.A_DIM)

    idx = 0
    while True:
        for i, (label, key, hot) in enumerate(actions):
            marker = "â€¢" if i == idx else " "
            line = f" {marker} [{hot.upper()}] {label}"
            attr = (curses.A_REVERSE | (TRANSP or curses.A_NORMAL)) if i == idx else (TRANSP or curses.A_NORMAL)
            win.addstr(4+i, 2, " "*(width-4), (TRANSP or curses.A_NORMAL))
            win.addstr(4+i, 2, line[:width-4], attr)
        win.refresh()
        k = stdscr.getch()
        if




